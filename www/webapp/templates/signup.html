{% extends "layout/base.html" %} {% block title %}
<title>TipsyTakedown - Sign</title>
{% endblock %} {% block body %}
<style>
  html,
  body {
    height: 100%;
  }

  .form-signin {
    max-width: 330px;
    padding: 1rem;
  }

  .form-signin .form-floating:focus-within {
    z-index: 2;
  }

  .form-signin input[type="email"] {
    margin-bottom: -1px;
    border-bottom-right-radius: 0;
    border-bottom-left-radius: 0;
  }

  .form-signin input[type="password"] {
    margin-bottom: 10px;
    border-top-left-radius: 0;
    border-top-right-radius: 0;
  }
</style>
<div class="container">
  <main class="form-signin w-100 m-auto">
    <form>
      <h1 id="main-title" class="h3 mb-3 fw-normal">Please fill the form</h1>
      <div class="mb-3">
        <label for="email" class="form-label">Email address</label>
        <input
          type="email"
          class="form-control"
          id="email"
          placeholder="Enter email"
          required
        />
      </div>
      <div class="mb-3 sign-up-form d-none sign-in-form">
        <label for="password" class="form-label">Password</label>
        <input
          type="password"
          class="form-control"
          id="password"
          placeholder="Enter password"
        />
      </div>
      <div class="mb-3 sign-up-form d-none">
        <label for="confirm_password" class="form-label"
          >Confirm Password</label
        >
        <input
          type="password"
          class="form-control"
          id="confirm_password"
          name="confirm_password"
        />
      </div>
      <div class="mb-3 sign-up-form d-none">
        <label for="given_name" class="form-label">Given Name</label>
        <input
          type="text"
          class="form-control"
          id="given_name"
          name="given_name"
        />
      </div>
      <div class="mb-3 sign-up-form d-none">
        <label for="surname" class="form-label">Surname</label>
        <input type="text" class="form-control" id="surname" name="surname" />
      </div>
      <div class="alert alert-danger d-none" role="alert" id="errorMessage">
        Invalid email or password
      </div>
      <div
        class="alert alert-danger d-none"
        role="alert"
        id="errorRegisterMessage"
      >
        Already taken the user
      </div>
      <button class="btn btn-primary w-100 py-2" id="btn-submit">Next</button>
    </form>
    <hr class="border-top" />
    <div class="text-center">
      <a class="btn btn-secondary w-100 py-2" href="/auth/google">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          fill="currentColor"
          class="bi bi-google"
          viewBox="0 0 16 16"
        >
          <path
            d="M15.545 6.558a9.4 9.4 0 0 1 .139 1.626c0 2.434-.87 4.492-2.384 5.885h.002C11.978 15.292 10.158 16 8 16A8 8 0 1 1 8 0a7.7 7.7 0 0 1 5.352 2.082l-2.284 2.284A4.35 4.35 0 0 0 8 3.166c-2.087 0-3.86 1.408-4.492 3.304a4.8 4.8 0 0 0 0 3.063h.003c.635 1.893 2.405 3.301 4.492 3.301 1.078 0 2.004-.276 2.722-.764h-.003a3.7 3.7 0 0 0 1.599-2.431H8v-3.08z"
          />
        </svg>
        <span class="mx-2">Sign in with Google</span>
      </a>
    </div>
  </main>
  <script>
    let existUser = false;
    let checkedEmail = false;
    const btnSubmit = document.getElementById("btn-submit");
    const signUpForm = document.getElementsByClassName("sign-up-form");
    const signInForm = document.getElementsByClassName("sign-in-form");
    const mainTitle = document.getElementById("main-title");

    async function checkMail() {
      const email = document.getElementById("email").value;

      const formData = {
        email: email,
      };

      const response = await fetch("/api/auth/check_email", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(formData),
      });

      if (!response.ok) {
        for (let i = 0; i < signUpForm.length; i++) {
          signUpForm[i].classList.remove("d-none");
          requiredSignUpInputs();
        }
        checkedEmail = true;
        btnSubmit.innerText = "Sign Up";
        mainTitle.innerText = "Please fill the sign up form";
      }

      if (response.ok) {
        for (let i = 0; i < signInForm.length; i++) {
          signInForm[i].classList.remove("d-none");
          requiredSignInInput();
        }
        checkedEmail = true;
        existUser = true;
        btnSubmit.innerText = "Sign In";
        mainTitle.innerText = "Please enter your password";
      }
    }
    async function loginForm() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      const errorMessage = document.getElementById("errorMessage");

      errorMessage.classList.add("d-none");

      const formData = {
        email: email,
        password: password,
      };

      const response = await fetch("/api/auth/sign_in", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(formData),
      });

      if (!response.ok) {
        errorMessage.classList.remove("d-none");
        return;
      }

      const data = await response.json();
      const token = data.token;
      if (token) {
        sessionStorage.setItem("token", token);
        window.location.href = "/";
      }
    }

    async function registerForm() {
      const given_name = document.getElementById("given_name").value;
      const surname = document.getElementById("surname").value;
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      const errorRegisterMessage = document.getElementById(
        "errorRegisterMessage"
      );

      errorRegisterMessage.classList.add("d-none");

      const formData = {
        email: email,
        password: password,
        given_name: given_name,
        surname: surname,
      };

      const response = await fetch("/api/auth/sign_up", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(formData),
      });

      if (!response.ok) {
        errorRegisterMessage.classList.remove("d-none");
        return;
      }
      if (response.ok) {
        loginForm();
      }
    }
    document.querySelector("form").addEventListener("submit", function (event) {
      event.preventDefault(); // Prevent the default form submission
      switch (true) {
        case !checkedEmail:
          checkMail();
          break;
        case existUser && checkedEmail:
          loginForm();
          break;
        case !existUser && checkedEmail:
          registerForm();
          break;
        default:
          break;
      }
    });
    function requiredSignUpInputs() {
      document.getElementById("password").setAttribute("required", "true");
      document
        .getElementById("confirm_password")
        .setAttribute("required", "true");
      document.getElementById("given_name").setAttribute("required", "true");
      document.getElementById("surname").setAttribute("required", "true");
    }
    function requiredSignInInput() {
      document.getElementById("password").setAttribute("required", "true");
    }
  </script>
</div>
{% endblock %}
